# bootstrap

## 简介

与传统的参数方法相比，bootstrap 方法更**具有一般性**。bootstrap 方法需要在计算机上作较多计算，由于现代计算机速度很快，bootstrap 方法已经成为一种流行方法。

这里的一般性，是指不需要知道总体分布，就可以计算标准差或置信区间。

bootstrap 是现代统计学较为流行的一种方法，在小样本时效果很好。通过方差的估计可以构造置信区间，使其运用范围得到进一步延伸。

## 非参数 bootstrap 方法

bootstrap 方法的目标是基于已知数据去估计未知参数，例如估计均值、中位数、标准差等，构造未知参数的置信区间，以及对参数做假设检验等。

设总体的分布 F 未知，但已经有一个容量为 n 的来自分布 F 的数据样本，自这一样本按**放回抽样**的方法抽取一个容量为 n 的样本，这种样本称为 **boot-strap 样本**，或称为**自助样本**。相继的、独立地自原始样本中取很**多个 bootstrap 样本**，利用这些样本对总体 F 进行统计推断，这种方法称为**非参数 bootstrap 方法**，又称自助法。这一方法可以用于当人们对总体知之甚少的情况，它是近代统计中的一种用于数据处理的重要实用方法。

### 估计量的标准误差的 bootstrap 估计

在估计总体未知参数 $\theta$ 时，人们不但要给出 θ 的估计 $\hat{\theta}$，还需要指出这一估计 $\hat{\theta}$ 的精度。通常我们用估计量 $\hat{\theta}$ 的标准差 $\sqrt{D(\hat{\theta})}$ 来度量估计 $\hat{\theta}$的精度。估计量 $\hat{\theta}$ 的标准差也成为估计量 $\hat{\theta}$ 的**标准误差**。

设 $(X_1,X_2,\cdots,X_n)$ 是来自以 $F(x)$ 为分布函数的总体的样本，θ 是待估计的未知参数。

$\sqrt{D(\hat{\theta})}$ 的 bootstrap **估计步骤**：

1. 对原始样本 $x=(x_1,x_2,\cdots,x_n)$ 按放回抽样的方法抽得容量为 n 的样本 $x……*=(x_1^*,x_2^*,\cdots,x_n^*)$，称为 bootstrap 样本
2. 相继地、独立地求出 B 个（$B\ge 10000$） 容量为 n 的 bootstrap 样本，计算 $\hat{\theta}_i^*=\hat{\theta}(x_1^{*i},x_2^{*i},\cdots,x_n^{*i})$, $i=1,2,\cdots,B$ ($\hat{\theta}_i^*$ 称为 $\theta$ 的第 i 个 bootstrap 估计)
3. 计算

$$
\hat{\sigma}_{\hat{\theta}}=\sqrt{\frac{1}{B-1}\sum_{i=1}^B(\hat{\theta}_i^*-\overline{\theta}^*)^2} \tag{1}
$$

其中，$\overline{\theta}^*=\frac{1}{B}\sum_{i=1}^B\hat{\theta}_i^*$。

> [!NOTE]
>
> 抽样方式：均匀分布随机放回抽样

**例 1** 某种基金的年回报率是具有分布函数 F 的连续型随机变量，F 未知，F 的中位数 $\theta$ 为未知参数。现有以下的 原始样本（单位 %）：

```
9.5 21.1 12.0 10.2 12.0 21.1 10.2
18.2 12.0 9.5 18.0 10.2 18.2
```

试求 F 的中位数的标准误差的 bootstrap 估计。

**解** 将原始样本从小到大排序，中间一个数为 12.0，得中位数为 12.0。相继地、独立地在上述 13 个数据中，按放回抽样的方法取样，取 B=10000。得到 10000 个 bootstrap 样本：

样本 1：

```
10.2 10.2 18.2 18.2 18.2 10.2 10.2 21.1 12.0 18.2
21.1 21.1 12.0
```

样本 2：

```
18.2 9.5 21.1 21.1 10.2 18.0 9.5 10.2 10.2 9.5
10.2 12.0 21.1
```

样本 10000：

```
21.1 9.5 10.2 9.5 12.0 12.0 21.1 18.2 18.0
21.1 12.0 9.5 21.1
```

对以上每个 bootstrap 样本，分别求出样本中位数 $\hat{\theta}_i^*$, $i=1,2,\cdots,10000$。将它们带入（1）式得到所求的标准误差的 bootstrap 估计为：
$$
\hat{\sigma}_{\hat{\theta}}=\sqrt{\frac{1}{9999}\sum_{i=1}^{10000}(\hat{\theta}_i^*-\overline{\theta}^*)^2}=.676131
$$
其中，$\overline{\theta}^*=\frac{1}{B}\sum_{i=1}^B\hat{\theta}_i^*$。

R 代码实现

```R
x <- c(9.5,21.1,12.0,10.2,12.0,21.1,10.2,18.2,12.0,9.5,18.0,10.2,18.2)
median(x)
n = length(x) # 样本量
N = 10000 # bootstrap 次数
k = 0
theta <- numeric(N)
for (i in 1:N) {
    xB <- sample(x, n, replace = TRUE) # 从样本 x 放回抽样 n 个
    theta[i] <- median(xB) # 计算中位数
    k <- k + median(xB)
}
thetabar <- k / N # 中位数平均值
squ <- 0.0 # 平方差加和
for (i in 1:N) {
    squ <- squ + (theta[i] - thetabar)^2
}
sigma.theta <- sqrt(squ / 9999)
```

### 估计量的均方误差的 bootstrap 估计

**例 2** （均方误差）设金属元素钳的升华热是具有分布函数 F（F 未知）的连续型随机变量。F 的中位数 θ 是未知参数，现测得以下的原始样本（以 kcal/mol 计）:

```
133.7 134.1 134.3 134.4 134.5 134.7 134.8 134.8 134.8
134.9 134.9 135.0 135.0 135.2 135.2 135.4 135.4 135.8
135.8 136.3 136.6 141.2 143.3 146.5 147.8 148.8
```

（数据已排序）。以原始样本的中位数 $M=M(x)$ 作为总体中位数 θ 的估计，试求**均方误差** $MSE=E[(M-\theta)^2]$ 的 bootstrap 估计。

**解** 将原始样本自小到大排序，左起第 13 个数为 135.0，左起第 14 个数为 135.2，于是原始样本的中位数为 135.1。以 135.1 作为总体中位数 θ 的估计，即 $\hat{\theta}=35.1$。需估计均值 $E[(M-135.1)^2]$。

相继地、独立地自原始样本抽取 10 000 个 bootstrap 样本如下：

样本 1：

```
143.3 134.8 148.8 135.4 135.2 135.2 134.8 134.4 134.7
135.2 135.0 135.0 135.4 135.4 136.3 134.4 134.9 134.8
136.6 134.1 134.8 134.8 133.7 134.8 134.8 134.4
```

得样本中位数为 $M_1^*=134.85$，$(M_1^*-135.1)^2=0.0625$。

样本 10000：

```
135.8 135.2 134.9 135.2 135.4 135.2 134.3 134.9
134.3 135.0 134.5 135.8 146.5 143.3 135.0 135.2
148.8 136.6 135.4 136.6 135.2 133.7 146.5 135.0
135.4 134.8
```

得样本中位数为 $M_{10000}^*=35.2$，$(M_{10000}^*-135.1)^2=0.01$。

将这 10000 个数 $(M_1^*-135.1)^2,\cdots,(M_{10000}^*-135.1)^2$ 取平均值，得到：
$$
\frac{1}{10000}\sum_{i=1}^{10000}(M_i^*-135.1)^2=0.07432325
$$
所以均方误差的 bootstrap 估计值为 0.07432325.

### 偏差的 bootstrap 估计



## Bootstrapping 步骤

1. 生成 bootstrapped 数据集
2. 计算统计量，如均值，中位数、方差等
3. 记录获得的统计量
4. 重复 1-3，直到 bootstrapped 统计量分布较好

以均值为例，大量 bootstrapped 样本获得的均值构成均值的 boostapped 分布，根据分布可以计算置信区间。

## 使用 Bootstrapping 计算 p-value

首先，提出零假设：例如，药物没有效果。



## 疑问

### 采样次数

没有具体的规则来指导样本个数。建议检查样本的直方图，看看分布是否规则。只有 bootstrap 样本的直方图看起来有规律，对统计量的 bootstrap 估计才合理。

如果假设检验是精确的，α 为期望显著性水平，B 为样本数，则必须满足如下条件：
$$
\alpha\cdot(1+B)=integer
$$
Davidson, R., & MacKinnon, J. G. (2000). Bootstrap tests: How many bootstraps?. Econometric Reviews, 19(1), 55-68. 

这篇文献对 p-value 进行 bootstrap 估计，建议对 0.05 最小样本数为 400（即 399），对 0.01 水平最小样本数为 1500（即 1499）。

