# 卡方检验和 F 分布

- [卡方检验和 F 分布](#卡方检验和-f-分布)
  - [1. 卡方拟合优度检验](#1-卡方拟合优度检验)
  - [2. 独立性检验](#2-独立性检验)
    - [列联表](#列联表)
    - [卡方独立性检验](#卡方独立性检验)
  - [3. 比较两个方差](#3-比较两个方差)
    - [F 分布](#f-分布)
    - [方差的双样本 F 检验](#方差的双样本-f-检验)
  - [方差分析](#方差分析)
    - [单因素方差分析](#单因素方差分析)

2024-12-09
@author Jiawei Mao
***

## 1. 卡方拟合优度检验

一家报税公司想要确定使用不同方法报税的人数比例。为了确定这些比例，该公司进行**多项式实验**（multinomial experiment）。多项式实验是一种概率实验，由固定数量的独立试验组成，每次试验都有两种以上的可能结果。每个结果的概率是固定的，并且每个结果都分为几类。

该公司希望测试零售贸易协会使用不同方法报税的人员比例的预期分布。为此，该公司可以将多项式实验获得的比例分布与该协会的预期分布进行比较。为了比较分布，该公司可以执行**卡方拟合优度检验**（chi-square goodness-of-fit test）。

> [!NOTE]
>
> 卡方拟合优度检验用于检验频率分布是否符合预期分布。

要拟合优度检验，首先陈述零假设和备择假设。通常零假设定义为频率分布符合预期分布，备择假设定义为频率分布不符合预期分布。

协会声称使用不同报税方式的人的预期分布为：

| 方式 | 比例 |
| ---- | ---- |
|会计师|24%|
|手动 |20%|
|软件|35%|
|朋友/家人|6%|
|报税服务|15%|

为了检验该协会的说法，该公司使用如下零假设和备择假设进行卡方拟合优度检验：

- $H_0$​：预计报税方法的分布为：会计师 24%，手动 20%，软件 35%，朋友/家人 6%，报税服务 15%。
- $H_a$：报税方法的分布与预期分布不同。

可以使用观测频率和预期频率计算卡方拟合优度检验的检验统计量。对预期频率，首先要假设零假设为 true。

一个类别的**观测频率** O 是样本数据中观察到的该类别的频率。

一个类别的**预期频率** E 可以使用预期分布和样本大小计算。第 i 个类比的预期频率为：
$$
E_i=np_i
$$
其中，$n$ 为样本量，$p_i$ 为第 i 个分类的预期概率。

**例 1** 计算观测频率和预期频率

一家报税公司随机选择了 300 名成年人，并询问他们如何报税。结果如下：

| 方式 | 频率 |
| ---- | ---- |
|会计师|63|
|手动 |40|
|软件|115|
|朋友/家人|29|
|报税服务|53|

计算每种报税方法的观测频率和预期频率（使用协会声称的比例）。

| 方式 | 人数比例 | 发现频率 | 预期频率 |
| ---- | ---- | ---- | ---- |
|会计师|24%|63|300*0.24=72|
|手动 |20%|40|300*0.20=60|
|软件|35%|115|300*0.35=105|
|朋友/家人|6%|29|300*0.06=18|
|报税服务|15%|53|300*0.15=45|

发现频率之和总是等于预期频率之和。

执行卡方优度检验之前，必须满足以下两个条件：

1. 观测频率是从随机样本获得
2. 每个预期频率至少为 5

注意：当某个分类的预期频率小于 5，可以将该类别与另一个类别合并，来满足第二个要求。

如果满足这两个条件，则抽样分布近似于自由度为 $k-1$ 的卡方分布，其中 $k$ 为类别数。**检验统计量**为：
$$
\chi^2=\sum \frac{(O-E)^2}{E}
$$

当观测频率与预期频率非常接近，O 和 E 之间的差异会很小，卡方检验统计量会接近于 0.因此不大可能拒绝零假设。

当观测频率与预期频率存在很大差异，O 和 E 之间的差异很大，从而导致卡方检验统计量很大。较大的卡方检验统计量是拒绝零假设的证据。因此，**卡方优度检验始终是右尾检验**。

**卡方优度检验流程**

1. 确定发现频率是从随机样本获得，预期频率至少为 5
2. 声明零假设和备择假设
3. 指定显著性水平
4. 确定自由度 $\text{d.f.}=k-1$
5. 根据卡方分布和显著性水平确定临界值
6. 确定拒绝域
7. 计算检验统计量

$$
\chi^2=\sum \frac{(O-E)^2}{E}
$$

8. 拒绝或无法拒绝零假设

如果 $\chi^2$ 在拒绝域，则拒绝 $H_0$，否则无法拒绝 $H_0$。

**例 2** 执行卡方优度检验

一家零售业协会声称，成年人的报税方法如下表所示。一家报税公司随机选择 300 名成年人，并询问他们如何报税。结果如下表。在 $\alpha=0.01$ 时，检验该协会的说法。

| 报税方式 | 预期比例 | 发现频率 | 预期频率 |
| ---- | ---- | ---- | ---- |
|会计师|24%|63|300*0.24=72|
|手动 |20%|40|300*0.20=60|
|软件|35%|115|300*0.35=105|
|朋友/家人|6%|29|300*0.06=18|
|报税服务|15%|53|300*0.15=45|

从上表可知预期频率均大于 5，且样本随机。因此可以使用卡方优度检验来检验分布。以下是零假设和备择假设：

- $H_0$​：预计报税方法的分布为：会计师 24%，手动 20%，软件 35%，朋友/家人 6%，报税服务 15%。
- $H_a$：报税方法的分布与预期分布不同。

因为有 5 个分类，因此卡方分布的自由度为 $\text{d.f.}=k-1=4$。

根据 $\text{d.f.}=4$, $\alpha=0.01$，从卡方分布得到临界值 $\chi_0^2=13.277$，因此拒绝域为：
$$
\chi^2>13.277
$$

根据发现频率和期望频率，得到:

$$
\begin{aligned}
    \chi^2&=\sum \frac{(O-E)^2}{E}\\
    &\approx 16.888
\end{aligned}
$$

如下图所示：

<img src="./images/image-20241209173343862.png" alt="image-20241209173343862" style="zoom:50%;" />

由于 $\chi^2$ 位于拒绝域，因此拒绝零假设。

**结论：** 在 1% 显著性水平下，有足够的证据来拒绝协会声称的报税方式分布。

卡方拟合优度检验常用于**确定分布是否是均匀**的。对于此类检验，类别的预期频率相等。在测试均匀分布时，可以通过将样本大小除以类别数得到每个类别的预期频率。

**例 3** 卡方拟合优度检验

一位研究人员声称 MM 豆中不同颜色糖果的数量是均匀分布的。为了检验该说法，随机选择一袋含有 500 颗巧克力豆的 MM 豆。结果如下表。在 $\alpha=0.10$ 时，检验该研究人员的说法。

|颜色|频率|
|---|---|
|Brown|80|
|Yello| 95|
|Red|88|
|Blue|83|
|Orange|76|
|Green|78|

**解：** 声称分布时均匀的，因此各个颜色的预期频率相等。对每种颜色。预期频率 $E500/6\approx 83.333$。由于每个预期频率大于 5，并且 MM 豆是随机选择的，因此可以使用卡方拟合优度检验来检验预期分布。以下是零假设和备择假设：

- $H_0$：MM 豆袋中不同颜色糖果的预期分布时均匀的
- $H_a$：MM 豆袋中不同颜色糖果的分布不均匀

因为有 6 个类别，因此卡方分布自由度为 $\text{d.f.}=k-1=5$。

根据自由度 $\text{d.f.}=5$, $\alpha=0.10$ 得到临界值为 $\chi^2_0=9.236$。因此，拒绝域为 $\chi^2>9.236$。

计算检验统计量：

<img src="./images/image-20241209174604786.png" alt="image-20241209174604786" style="zoom:50%;" />

下图显示拒绝域和卡方检验统计量的位置。因此 $\chi^2$ 不在拒绝域，因此无法拒绝零假设：

<img src="./images/image-20241209175131874.png" alt="image-20241209175131874" style="zoom:50%;" />

**结论：** 在 10% 显著性水平下，没有足够证据拒绝 MM 豆糖果颜色的分布时均匀的这一说法。

## 2. 独立性检验

### 列联表

当一个事件的发生不影响另一个事件的发生的概率时，两个事件独立。下面使用卡方独立性检验来判断两个变量是否存在关系。要执行卡方独立性检验，先以**列联表**（contingency table）形式组织样本数据。

$r\times c$ 列联表显示两个变量的观测频率。观测频率排列成 r 行 c 列。行和列的交叉点称为**单元格**（cell）。

下面是一个 $2\times 5$ 列联表。它有 2 行 5 列，显示 2197 名成年人的随机样本结果，这些样本按两个样本分类：最喜欢吃冰淇淋的方式和性别。从表中可以看出，喜欢圣代冰淇淋的成年人中有 182 名男性和 158 名女性。

|性别|杯装|甜筒|圣代|三明治|其它|
|---|---|---|---|---|---|
|男|504 |287 |182 |43 |53|
|女| 474| 401 |158 |45 |50|

假设两个变量是独立的，就可以使用列联表计算每个 cell 的期望频率。列联表中单元格 $E_{r,c}$ 的期望频率为：

$$
\text{期望频率} E_{r,c}=\frac{(\text{sum of row r})(\text{sum of column c})}{\text{sample size}}
$$

每列或者每行的加和，成为**边缘频率**（marginal frequency）。边缘频率是某个变量的整个类别出现的频率。例如，在上表中，喜欢甜筒冰淇淋的成年人的边缘频率为 $287+401=688$。在列联表内部观察的频率称为**联合频率**（joint frequency）。

**例 1** 计算期望频率

计算列联表中每个 cell 的期望频率。假设喜欢吃冰淇淋类型和性别两个变量独立。

|性别|杯装|甜筒|圣代|三明治|其它|加和|
|---|---|---|---|---|---|---|
|男|504 |287 |182 |43 |53|1069|
|女| 474| 401 |158 |45 |50|1128|
|加和|978|688|340|88|103|2197|

该列联表已经给出了边缘频率。

**解：** 根据如下公式计算单元格的期望频率：

$$
\text{Expected frequency} E_{r,c}=\frac{(\text{sum of row r})(\text{sum of column c})}{\text{sample size}}
$$

第一行的期望频率：

$$
E_{1,1}=\frac{1069*978}{2197}\approx 475.868
$$

$$
E_{1,2}=\frac{1069*688}{2197}\approx 334.762
$$

$$
E_{1,3}=\frac{1069*340}{2197}\approx 165.435
$$

$$
E_{1,4}=\frac{1069*88}{2197}\approx 42.818
$$

$$
E_{1,5}=\frac{1069*103}{2197}\approx 50.117
$$

第二行的期望频率：

$$
E_{2,1}=\frac{1128*978}{2197}\approx 502.132
$$

$$
E_{2,2}=\frac{1128*688}{2197}\approx 353.238
$$

$$
E_{2,3}=\frac{1128*340}{2197}\approx 174.565
$$

$$
E_{2,4}=\frac{1128*88}{2197}\approx 45.182
$$

$$
E_{2,5}=\frac{1128*103}{2197}\approx 52.883
$$

### 卡方独立性检验

获得期望频率后，就可以使用**卡方独立性检验**（chi-square independence test）来分析变量是否独立。

> [!NOTE]
>
> 卡方独立性检验用于检验两个变量是否独立。通过次检验，可以确定一个变量出现的是否会影响另一个变量的概率。

在进行卡方独立性检验之前，必须确保：

1. 观测到的频率是从随机样本中获得、
2. 每个期望频率不少于 5

满足该条件，检验统计量：
$$
\chi^2=\frac{(O-E)^2}{E}
$$
就近似卡方分布，自由度为：
$$
\text{d.f.}=(r-1)(c-1)
$$

其中 r 和 c 分别为列联表的行数和列数，O 为观测频率，E 为期望频率。

独立性检验的第一步是陈述零假设和备择假设。对卡方独立性检验：

- $H_0$：变量独立
- $H_a$：变量相关

假设两个变量独立，计算出期望频率。如果变量独立，那么频率的观察值和预期值差异很小，卡方检验统计量将接近 0.

对相关变量，频率的观察值和期望值可能相差 很大。当 O 和 E 差异很大时，卡方检验统计量很大，较大的卡方检验是拒绝零假设的证据。因此，**卡方独立性检验始终是右尾检验**。

**卡方独立性检验流程**

1. 确定观察频率从随机样本获得，每个期望频率不小于 5；
2. 声明假设
3. 指定显著性水平
4. 确定自由度：$\text{d.f.}=(r-1)(c-1)$
5. 根据卡方分布确定临界值
6. 确定拒绝域
7. 计算检验统计量

$$
\chi^2=\frac{(O-E)^2}{E}
$$

8. 拒绝或无法拒绝零假设：如果 $\chi^2$ 在拒绝域，则拒绝 $H_0$，否则无法拒绝 $H_0$

**例 2** 执行卡方独立性检验

列联表显示 2197 名成年人的随机样本结果，这些样本按照他们最喜欢的吃冰淇淋类型和性别进行分类。括号内为期望频率。当 $\alpha=0.01$，能够得出 “最喜欢吃冰淇淋的方式” 和 “性别” 这两个变量是相关的结论？

<img src="./images/image-20241209191312473.png" alt="image-20241209191312473" style="zoom:50%;" />

**解：** 每个频率期望值大于 5，并且成年人是随机选择的，因此可以使用卡方独立性检验来检验来检验两个变量是否独立。以下是零假设和备择假设：

- $H_0$：最喜欢吃冰淇淋的方式和性别这两个变量是独立的
- $H_a$：最喜欢吃冰淇淋的方式和性别这两个变量是相关的

列联表有 2 行 5 列，因此卡方分布自由度为：$\text{d.f.}=(r-1)(c-1)=4$。

根据自由度 $\text{d.f.}=4$ 和显著性水平 $\alpha=0.01$，基于卡方分布得到临界值 $\chi^2_0=13.277$。因此拒绝域为 $\chi^2>13.277$。计算卡方检验统计量：

<img src="./images/image-20241209192038380.png" alt="image-20241209192038380" style="zoom:50%;" />

如下图所示：

<img src="./images/image-20241209192057896.png" alt="image-20241209192057896" style="zoom:50%;" />

用于卡方检验统计量在拒绝域中，因此拒绝零假设。

**结论：** 在 1% 显著性水平，有足够证据得出 "喜欢吃冰淇淋的方式" 和 "性别" 这两个变量是相关的。

## 3. 比较两个方差

### F 分布

通过**双样本 F 检验**判断两个总体方差是否相等。下面介绍 F 分布以及如何使用它来比较两个方差。

令 $s_1^2$ 和 $s_2^2$ 表示两个不同总体的样本方差。如果两个总体都是正态，并且总体方差 $\sigma_1^2$ 和 $\sigma_2^2$ 相等，则：

$$
F=\frac{s_1^2}{s_2^2}
$$

服从 F 分布。F 分布具有如下性质：

1. F 分布是一组曲线，每条曲线由两种类型的自由度决定：分子方差自由度 $\text{d.f.}_N$ 和分母方差自由度 $\text{d.f.}_D$；
2. F 分布为正偏态，分布不对称（见下图）；
3. F 分布曲线下的总面积等于 1；
4. F 的所有值大于或等于 0；
5. 对所有 F 分布，F 的平均值近似为 1.

<img src="./images/image-20241209193450092.png" alt="image-20241209193450092" style="zoom:50%;" />

对方差不等的情况，将较大的方差指定为 $s_1^2$。因此，在 $F=s_1^2/s_2^2$ 抽样分布中，分子的方差大于>=分母的方差，F 始终 >= 1。因此，所有单尾检验都是右尾检验，对所有双尾检验，只需要找到右尾临界值。

**计算 F 分布临界值的流程**

1. 指定显著性水平
2. 确定分子自由度 $\text{d.f.}_N$
3. 确定分母自由度 $\text{d.f.}_D$
4. 查找临界值

a. 对单尾检验，使用 $\alpha$
b. 对双尾检验，使用 $0.5\alpha$

**例 1** 计算右尾检验的临界 F 值

令 $\alpha=0.10$, $\text{d.f.}_N=5$, $\text{d.f.}_D=28$。采用代码计算：

```java
public static double getOneTailedCriticalValue(int dfN, int dfD, double alpha) {
    FDistribution distribution = new FDistribution(dfN, dfD);
    return distribution.inverseCumulativeProbability(1 - alpha);
}
```

```java
double criticalValue = FTestUtils.getOneTailedCriticalValue(5, 28, 0.10);
assertEquals(2.06, criticalValue, 0.01);
```

图示：

<img src="./images/image-20241209194331033.png" alt="image-20241209194331033" style="zoom:50%;" />

**例 2** 计算双尾检验的 F 值

令 $\alpha=0.05$, $\text{d.f.}_N=4$, $\text{d.f.}_D=8$。

```java
public static double getTwoTailedCriticalValue(int dfN, int dfD, double alpha) {
    FDistribution distribution = new FDistribution(dfN, dfD);
    return distribution.inverseCumulativeProbability(1 - alpha / 2);
}
```

```java
double criticalValue = FTestUtils.getTwoTailedCriticalValue(4, 8, 0.05);
assertEquals(5.05, criticalValue, 0.01);
```

图示：

<img src="./images/image-20241209194644002.png" alt="image-20241209194644002" style="zoom:50%;" />

### 方差的双样本 F 检验

下面介绍如何执行双样本 F 检验，使用来自每个总体的样本来比较两个总体的方差。

双样本 F 检验用于比较两个总体方差 $\sigma_1^2$ 和 $\sigma_2^2$。要执行该检验，必须满足：

1. 样本随机
2. 样本独立
3. 每个总体都是正态分布

检验统计量为：

$$
F=\frac{s_1^2}{s_2^2}
$$

其中 $s_1^2$ 和 $s_2^2$ 为样本方差，且 $s_1^2\ge s_2^2$。

分子自由度为 $\text{d.f.}_N=n_1-1$，分母自由度为 $\text{d.f.}_D=n_1-1$，其中 $n_1$ 是具有方差 $s_1^2$ 的样本的大小，$n_2$ 是具有方差 $s_2^2$ 的样本的大小。

**使用双样本 F 检验比较 $\sigma_1^2$ 和 $\sigma_2^2$ 的流程**

1. 确定样本随机、独立，总体为正态分布
2. 声明假设
3. 执行显著性水平
4. 确定自由度
5. 计算临界值
6. 确定拒绝域
7. 计算检验统计量

$$
F=\frac{s_1^2}{s_2^2}
$$

8. 根据 F 是否在拒绝域，决定是拒绝还是无法拒绝零假设

**例 3** 双样本 F 检验

一位餐厅经理正在试用一个系统，旨在减少顾客点餐前等待时间的方差。在旧系统，随机抽取 10 位顾客的方差为 400；在新系统，随机抽取 21 位顾客的方差为 256.当 $\alpha=0.10$ 时，是否有足够的证据说服经理改用新系统？假设两个总体是正态分布。

**解：** 因为 400>256，所以 $s_1^2=400$, $s_2^2=256$。对于“新系统下的等待时间方差小于旧系统的等待时间方差”，对应的假设：

- $H_0$: $\sigma_1^2\le \sigma_2^2$
- $H_a$: $\sigma_1^2>\sigma_2^2$

这是一个右尾检验，$\alpha=0.10$，自由度为：

$$
\text{d.f.}_D=n_1-1=9
$$

$$
\text{d.f.}_N=n_2-1=20
$$

对应临界值 $F_0=1.96$，因此拒绝域为 $F>1.96$。检验统计量为：

$$
F=\frac{s_1^2}{s_2^2}=\frac{400}{256}\approx 1.56
$$

如下图所示：

<img src="./images/image-20241209200101286.png" alt="image-20241209200101286" style="zoom:50%;" />

由于 F 不在拒绝域，因此无法拒绝零假设。

**结论：** 在 10% 显著性水平，没有足够的证据证明新系统的平均等待时间方差更小。

## 4. 方差分析

### 单因素方差分析

